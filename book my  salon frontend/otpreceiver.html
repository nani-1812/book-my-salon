<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verify Your Phone | Book My Salon</title>
    <link rel="stylesheet" href="global.css" />
    <style>
        /* Single OTP Input Box Style Override (‡∞Æ‡±Ä‡∞∞‡±Å ‡∞Ö‡∞°‡∞ø‡∞ó‡∞ø‡∞®‡∞ü‡±ç‡∞≤‡±Å‡∞ó‡∞æ) */
        #otpInput {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.5rem;
            text-align: center;
            letter-spacing: 0.5rem; /* Helps spread out the numbers */
            background-color: var(--bg-secondary);
            color: var(--text-color);
        }
        #otpInput:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(var(--accent-primary-rgb), 0.3);
            outline: none;
        }
    </style>
</head>
<body data-theme="light">
    <header>
        <a href="frontpage.html" class="logo" id="mainLogo">Book My Salon</a>
        <div class="header-controls">
            <div class="header-actions">
                <button id="themeToggle" class="theme-toggle" title="Toggle Dark/Light Mode">üåô</button>
            </div>
        </div>
    </header>

    <main class="otp-page-container">
        <div class="otp-form-container">
            <h2>Verify Your Phone Number</h2>
            <p id="infoText" class="info-text">Please enter the 6-digit OTP sent to <strong id="phoneNumberDisplay">+91...</strong>.</p>
            
            <form id="otpForm">
                <input type="tel" id="otpInput" placeholder="------" required maxlength="6" pattern="\d{6}" inputmode="numeric" autocomplete="one-time-code" />

                <div id="message" class="message-area" style="min-height: 25px; margin-top: 1rem; text-align: center;"></div>

                <button type="submit" class="submit-btn" id="verifyBtn" style="margin-top: 2rem;">Verify OTP</button>
            </form>

            <button id="resendBtn" class="btn-resend" style="margin-top: 1.5rem;" disabled>Resend OTP (60s)</button>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Book My Salon. All rights reserved.</p>
    </footer>

    <script src="theme-switcher.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:3000';
        const savedPhoneNumber = localStorage.getItem('tempPhoneNumber'); // ‡∞á‡∞¶‡∞ø 10 ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤ ‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á
        const otpMode = localStorage.getItem('otpMode'); // 'login' or 'signup'
        let resendTimer = 60;

        const resendBtn = document.getElementById('resendBtn');
        const otpInput = document.getElementById('otpInput');
        const messageDiv = document.getElementById('message');
        const verifyBtn = document.getElementById('verifyBtn');
        let timerInterval;

        function displayMessage(text, isError = true) {
            messageDiv.innerHTML = `<span style="color:${isError ? 'red' : 'green'};">${text}</span>`;
        }

        // --- RESEND TIMER LOGIC ---
        function startResendTimer() {
            resendTimer = 60;
            resendBtn.disabled = true;
            if (timerInterval) clearInterval(timerInterval); 
            
            resendBtn.textContent = `Resend OTP (${resendTimer}s)`;
            
            timerInterval = setInterval(() => {
                resendTimer--;
                resendBtn.textContent = `Resend OTP (${resendTimer}s)`;
                if (resendTimer <= 0) {
                    clearInterval(timerInterval);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'Resend OTP';
                }
            }, 1000);
        }

        // --- RESEND API CALL ---
        resendBtn.addEventListener('click', async () => {
             displayMessage('Sending new OTP...', false);
             try {
                 const response = await fetch(`${API_BASE_URL}/api/auth/send-otp`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ phoneNumber: `+91${savedPhoneNumber}`, mode: otpMode }) // <--- ‡∞á‡∞ï‡±ç‡∞ï‡∞° +91 ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø
                 });
                 const data = await response.json();
                 if (response.ok && data.success) {
                     displayMessage('New OTP sent successfully!', false);
                     startResendTimer();
                 } else {
                     displayMessage(data.message || 'Failed to resend OTP.');
                 }
             } catch (error) {
                 displayMessage('Network error during resend.');
             }
        });

        // --- PRE-LOAD CHECK ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!savedPhoneNumber || !otpMode) {
                alert('Session expired or flow error. Please start again.');
                window.location.href = 'login.html'; // Go to login
                return;
            }
            
            // Assuming savedPhoneNumber is already the 10-digit number
            document.getElementById('phoneNumberDisplay').textContent = 
                `+91 ${savedPhoneNumber.slice(0, 2)}...${savedPhoneNumber.slice(-4)}`; // <--- ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø
            
            startResendTimer(); // Start timer on page load
        });

        // --- VERIFY OTP API CALL ---
        document.getElementById('otpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const otpCode = otpInput.value.trim();

            if (otpCode.length !== 6) {
                displayMessage('Please enter the full 6-digit OTP.');
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';
            displayMessage('', false);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phoneNumber: `+91${savedPhoneNumber}`, // <--- ‡∞á‡∞ï‡±ç‡∞ï‡∞° +91 ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø
                        otp: otpCode,
                        mode: otpMode // 'login' or 'signup'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success && data.token) {
                    displayMessage('Success! Redirecting to your dashboard...', false);
                    
                    localStorage.setItem('authToken', data.token); 
                    localStorage.setItem('userId', data.user._id);
                    localStorage.setItem('userName', data.user.name);
                    
                    // Clear temporary data
                    localStorage.removeItem('tempPhoneNumber');
                    localStorage.removeItem('otpMode');
                    
                    // ‡∞°‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç‚Äå‡∞ï‡±Å ‡∞∞‡±Ä‡∞°‡±à‡∞∞‡±Ü‡∞ï‡±ç‡∞ü‡±ç
                    setTimeout(() => {
                        window.location.href = 'dashboard.html'; // <--- CORRECT REDIRECT
                    }, 1500);
                    
                } else {
                    throw new Error(data.message || 'Invalid OTP or server error.');
                }
            } catch (error) {
                console.error('Verify OTP Error:', error);
                displayMessage(error.message || 'Unknown network error.');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify OTP';
            }
        });
    </script>
</body>
</html>